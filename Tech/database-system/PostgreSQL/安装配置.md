---
title: å®‰è£…é…ç½®
description: Postgresql å®‰è£…é…ç½®
keywords:
  - Postgresql
  - å®‰è£…é…ç½®
tags:
  - æ•°æ®åº“ç³»ç»Ÿ/PostgreSQL
sidebar_position: 3
author: 7Wate
date: 2023-09-20
---

## åºè¨€

å¯¹äºåˆå­¦è€…å’Œæœ‰ç»éªŒçš„å¼€å‘è€…æ¥è¯´ï¼Œæ­£ç¡®åœ°å®‰è£…å’Œé…ç½® PostgreSQL æ˜¯è‡³å…³é‡è¦çš„ã€‚ä¸€ä¸ªæ°å½“çš„é…ç½®ä¸ä»…å¯ä»¥ç¡®ä¿æ•°æ®åº“çš„ç¨³å®šè¿è¡Œï¼Œè¿˜å¯ä»¥å……åˆ†å‘æŒ¥å…¶æ€§èƒ½ï¼Œæ»¡è¶³å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ã€‚ç„¶è€Œï¼Œç”±äº PostgreSQL çš„åŠŸèƒ½ä¸°å¯Œå’Œé…ç½®é¡¹ç¹å¤šï¼Œå¾ˆå¤šäººåœ¨å®‰è£…å’Œé…ç½®è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°å›°æƒ‘å’ŒæŒ‘æˆ˜ã€‚

PostgreSQL æä¾›äº†å¤šç§å®‰è£…æ–¹å¼ï¼Œå…¶ä¸­æºç å®‰è£…å’Œç¼–è¯‘å®‰è£…æ˜¯æœ€ä¸ºåŸºç¡€å’ŒåŸå§‹çš„æ–¹æ³•ã€‚è¿™ä¸¤ç§æ–¹æ³•è™½ç„¶ç›¸å¯¹å¤æ‚ï¼Œä½†ä¸ºç”¨æˆ·æä¾›äº†æå¤§çš„çµæ´»æ€§ï¼Œå…è®¸ä»–ä»¬æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œå®šåˆ¶å’Œä¼˜åŒ–ã€‚

## ä¾èµ–

| ä¾èµ–                 | ç‰ˆæœ¬         | ç”¨é€”                                        | çŠ¶æ€ | å¤‡æ³¨                                          |
| -------------------- | ------------ | ------------------------------------------- | ---- | --------------------------------------------- |
| GNU make             | 3.81 æˆ–æ›´é«˜  | æ„å»º PostgreSQL                             | âœ…    | å¿…éœ€; å…¶ä»–ç‰ˆæœ¬æˆ–å…¶ä»– make ç¨‹åºä¸å¯ç”¨          |
| ISO/ANSI C compiler  | C99 å…¼å®¹     | ç¼–è¯‘ PostgreSQL                             | âœ…    | å¿…éœ€; æ¨èä½¿ç”¨ GCC çš„æœ€æ–°ç‰ˆæœ¬                 |
| tar                  | æ— ç‰¹å®šç‰ˆæœ¬   | è§£å‹æºä»£ç åˆ†å‘åŒ…                            | âœ…    | å¿…éœ€; éœ€è¦é…åˆ gzip æˆ– bzip2 ä½¿ç”¨             |
| GNU Readline library | æ— ç‰¹å®šç‰ˆæœ¬   | æé«˜ PostgreSQL å‘½ä»¤è¡Œ SQL è§£é‡Šå™¨çš„ç”¨æˆ·ä½“éªŒ | âœ…    | å¿…éœ€; å¯ä»¥é€‰æ‹©ä¸ä½¿ç”¨æˆ–ä½¿ç”¨ libedit åº“ä½œä¸ºæ›¿ä»£ |
| zlib                 | æ— ç‰¹å®šç‰ˆæœ¬   | æ”¯æŒ pg_dump å’Œ pg_restore ä¸­çš„å‹ç¼©å­˜æ¡£åŠŸèƒ½ | âœ…    | å¿…éœ€; å¯ä»¥é€‰æ‹©ä¸ä½¿ç”¨                          |
| Perl                 | 5.8.3 æˆ–æ›´é«˜ | æ„å»º PL/Perl æœåŠ¡å™¨ç¼–ç¨‹è¯­è¨€                 | ğŸŸ¢    | å¯é€‰; éœ€è¦ libperl å…±äº«åº“å’Œå¤´æ–‡ä»¶             |
| Python               | 3.2 æˆ–æ›´é«˜   | æ„å»º PL/Python æœåŠ¡å™¨ç¼–ç¨‹è¯­è¨€               | ğŸŸ¢    | å¯é€‰; éœ€è¦ libpython å…±äº«åº“å’Œå¤´æ–‡ä»¶           |
| Tcl                  | 8.4 æˆ–æ›´é«˜   | æ„å»º PL/Tcl ç¨‹åºè¯­è¨€                        | ğŸŸ¢    | å¯é€‰; éœ€è¦ Tcl å®‰è£…                           |
| OpenSSL              | 1.0.1 æˆ–æ›´é«˜ | æ”¯æŒåŠ å¯†çš„å®¢æˆ·ç«¯è¿æ¥å’Œéšæœºæ•°ç”Ÿæˆ            | ğŸŸ¢    | å¯é€‰; ç”¨äºæ”¯æŒåŠ å¯†çš„å®¢æˆ·ç«¯è¿æ¥å’Œéšæœºæ•°ç”Ÿæˆ    |
| Gettext API          | æ— ç‰¹å®šç‰ˆæœ¬   | å®ç° Native Language Support (NLS)          | ğŸŸ¢    | å¯é€‰; ç”¨äºæ˜¾ç¤ºç¨‹åºçš„éè‹±è¯­æ¶ˆæ¯                |
| Kerberos             | æ— ç‰¹å®šç‰ˆæœ¬   | æ”¯æŒ Kerberos è®¤è¯                          | ğŸŸ¢    | å¯é€‰; ç”¨äºæ”¯æŒ Kerberos è®¤è¯                  |
| OpenLDAP             | æ— ç‰¹å®šç‰ˆæœ¬   | æ”¯æŒ OpenLDAP è®¤è¯                          | ğŸŸ¢    | å¯é€‰; ç”¨äºæ”¯æŒ OpenLDAP è®¤è¯                  |
| PAM                  | æ— ç‰¹å®šç‰ˆæœ¬   | æ”¯æŒ PAM è®¤è¯                               | ğŸŸ¢    | å¯é€‰; ç”¨äºæ”¯æŒ PAM è®¤è¯                       |
| LZ4                  | æ— ç‰¹å®šç‰ˆæœ¬   | æ”¯æŒ LZ4 æ•°æ®å‹ç¼©                           | ğŸŸ¢    | å¯é€‰; ç”¨äºæ”¯æŒ LZ4 æ•°æ®å‹ç¼©                   |
| Zstandard            | 1.4.0 æˆ–æ›´é«˜ | æ”¯æŒ Zstandard æ•°æ®å‹ç¼©                     | ğŸŸ¢    | å¯é€‰; ç”¨äºæ”¯æŒ Zstandard æ•°æ®å‹ç¼©             |

- âœ… è¡¨ç¤ºå¿…éœ€
- ğŸŸ¢ è¡¨ç¤ºå¯é€‰

### åŸºæœ¬ä¾èµ–

```shell
# YUM æ›´æ–°è½¯ä»¶ä»“åº“ && å®‰è£…å¿…éœ€çš„ä¾èµ–
sudo yum update -y && sudo yum install -y make gcc tar gzip bzip2 readline readline-devel zlib zlib-devel

# APT æ›´æ–°è½¯ä»¶ä»“åº“ && å®‰è£…å¿…éœ€çš„ä¾èµ–
sudo apt update && sudo apt install -y make gcc tar gzip bzip2 libreadline-dev zlib1g-dev
```

### æ‹“å±•ä¾èµ–

```shell
# YUM æ›´æ–°è½¯ä»¶ä»“åº“ && å®‰è£…å¯é€‰çš„ä¾èµ–
sudo yum update -y && sudo yum install -y perl perl-devel python3 python3-devel tcl tcl-devel openssl openssl-devel gettext krb5 krb5-devel openldap openldap-devel pam pam-devel lz4 lz4-devel zstd zstd-devel

# APT æ›´æ–°è½¯ä»¶ä»“åº“ && å®‰è£…å¯é€‰çš„ä¾èµ–
sudo apt update && sudo apt install -y perl libperl-dev python3 python3-dev tcl tcl-dev libssl-dev gettext krb5-user libkrb5-dev libldap2-dev libpam0g-dev liblz4-dev libzstd-dev
```

### ä¾èµ–æ£€æŸ¥

```shell
#!/bin/bash

# æ£€æŸ¥åŒ…ç®¡ç†å™¨
# å¯è‡ªå®šä¹‰ä¾èµ–æ£€æŸ¥é¡¹ç›®
if command -v yum &> /dev/null; then
  PACKAGE_MANAGER="yum"
  REQUIRED_DEPENDENCIES=("make" "gcc" "tar" "gzip" "bzip2" "readline" "readline-devel" "zlib" "zlib-devel")
  OPTIONAL_DEPENDENCIES=("perl" "perl-devel" "python3" "python3-devel" "tcl" "tcl-devel" "openssl" "openssl-devel" "gettext" "krb5" "krb5-devel" "openldap" "openldap-devel" "pam" "pam-devel" "lz4" "lz4-devel" "zstd" "zstd-devel")
elif command -v apt-get &> /dev/null; then
  PACKAGE_MANAGER="apt-get"
  REQUIRED_DEPENDENCIES=("make" "gcc" "tar" "gzip" "bzip2" "libreadline-dev" "zlib1g-dev")
  OPTIONAL_DEPENDENCIES=("perl" "libperl-dev" "python3" "python3-dev" "tcl" "tcl-dev" "libssl-dev" "gettext" "krb5-user" "libkrb5-dev" "libldap2-dev" "libpam0g-dev" "liblz4-dev" "libzstd-dev")
else
  echo "âŒ ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨ã€‚"
  exit 1
fi

# å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…ï¼Œå¹¶æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
check_dependency() {
  local package_name=$1

  if [ -z "$package_name" ]; then
    echo "é”™è¯¯ï¼šæœªæä¾›ä¾èµ–é¡¹åç§°ã€‚"
    exit 1
  fi

  if [ "$PACKAGE_MANAGER" == "yum" ]; then
    if rpm -q $package_name &> /dev/null; then
      version=$(rpm -q $package_name)
      printf " âœ… %-20s ç‰ˆæœ¬: %s\n" $package_name "$version"
    else
      printf " âŒ %-20s æœªå®‰è£…\n" $package_name
    fi
  elif [ "$PACKAGE_MANAGER" == "apt-get" ]; then
    if dpkg -s $package_name &> /dev/null; then
      version=$(dpkg -s $package_name | grep Version | cut -d' ' -f2)
      if [ -z "$version" ]; then
        version="æœªçŸ¥"
      fi
      printf " âœ… %-20s ç‰ˆæœ¬: %s\n" $package_name "$version"
    else
      printf " âŒ %-20s æœªå®‰è£…\n" $package_name
    fi
  fi
}

# å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ£€æŸ¥ä¾èµ–é¡¹æ•°ç»„
check_dependencies() {
  local dependencies=("$@")
  for dependency in "${dependencies[@]}"; do
    check_dependency "$dependency"
  done
}

# æ£€æŸ¥å¿…éœ€çš„ä¾èµ–
echo "Postgres ä¾èµ–æ£€æŸ¥"
echo "=> å¿…éœ€çš„ä¾èµ–ï¼š"
check_dependencies "${REQUIRED_DEPENDENCIES[@]}"

# æ£€æŸ¥å¯é€‰çš„ä¾èµ–
echo ""
echo "=> å¯é€‰çš„ä¾èµ–ï¼š"
check_dependencies "${OPTIONAL_DEPENDENCIES[@]}"

# è¾“å‡ºæ£€æŸ¥å®Œæˆä¿¡æ¯
echo ""
echo "=> ä¾èµ–æ£€æŸ¥å®Œæˆï¼"
```

## å®‰è£…

### æºç å®‰è£…

#### 1. å‡†å¤‡å·¥ä½œ

```shell
# åˆ›å»ºç”¨æˆ·
sudo adduser postgres
sudo passwd postgres

# åˆ›å»ºç›®å½•
sudo mkdir -p /opt/postgresql/{data,archive,scripts,backup,pg16,source,logs,config,temp,extensions,upgrade_scripts}

# é…ç½®ç›®å½•æƒé™ï¼Œåç»­é»˜è®¤ä»¥ postgres ç”¨æˆ·æ“ä½œ
sudo chown -R postgres:postgres /opt/postgresql
sudo chmod -R 775 /opt/postgresql
```

postgresql ç›®å½•ä¸‹æ–‡ä»¶å¤¹å…¶å¯¹åº”çš„ç”¨é€”ã€‚

| ç›®å½•             | ç”¨é€”                 |
| :--------------- | :------------------- |
| /data            | å­˜å‚¨ PostgreSQL æ•°æ® |
| /archive         | å­˜å‚¨å½’æ¡£æ—¥å¿—æ–‡ä»¶     |
| /scripts         | å­˜å‚¨ PostgreSQL è„šæœ¬ |
| /backup          | å­˜å‚¨æ•°æ®åº“å¤‡ä»½       |
| /pgsql           | è½¯è¿æ¥åˆ° /pg16       |
| /pg16            | PostgreSQL 16 ç‰ˆæœ¬   |
| /source          | å­˜å‚¨æºä»£ç æˆ–é…ç½®æ–‡ä»¶ |
| /logs            | å­˜å‚¨ PostgreSQL æ—¥å¿— |
| /config          | å­˜å‚¨ PostgreSQL é…ç½® |
| /temp            | å­˜å‚¨ä¸´æ—¶æ–‡ä»¶         |
| /extensions      | å­˜å‚¨ PostgreSQL æ‰©å±• |
| /upgrade_scripts | å­˜å‚¨å‡çº§è„šæœ¬         |

#### 2. ä¸‹è½½æºç 

PostgreSQL æºç å¯ä»¥åœ¨å®˜æ–¹æä¾›çš„ [FTP æ¸ é“](https://www.postgresql.org/ftp/source/) ä¸‹è½½ã€‚

![PostgreSQL æºç ](https://static.7wate.com/img/2023/09/22/7f25aaababea4.png)

```shell
# åˆ‡æ¢ç”¨æˆ·
su - postgres

# ä¸‹è½½ PG16 
postgres@debian:/opt/postgresql/source$ wget https://ftp.postgresql.org/pub/source/v16.0/postgresql-16.0.tar.gz

# è§£å‹ PG16
postgres@debian:/opt/postgresql/source$ tar -zxvf postgresql-16.0.tar.gz
```

#### 3. é…ç½®æºç 

é¦–å…ˆï¼Œä½ éœ€è¦é…ç½®æºä»£ç æ ‘ä»¥é€‚åº”ä½ çš„ç³»ç»Ÿå¹¶é€‰æ‹©ä½ æƒ³è¦çš„é€‰é¡¹ã€‚è¿™æ˜¯é€šè¿‡è¿è¡Œ `configure` è„šæœ¬å®Œæˆçš„ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œé»˜è®¤å®‰è£…ï¼š

```shell
# å®‰è£… /opt/postgresql/pg16/ è·¯å¾„
postgres@debian:/opt/postgresql/source/postgresql-16.0$ ./configure --prefix=/opt/postgresql/pg16/
```

```shell
# é»˜è®¤å®‰è£…
./configure

# æŒ‡å®šå¤šä¸ªé€‰é¡¹
./configure --prefix=/usr/local/pgsql --bindir=/usr/local/pgsql/bin --datadir=/usr/local/pgsql/data --libdir=/usr/local/pgsql/lib

# ç¦ç”¨æŸäº›åŠŸèƒ½
./configure --without-readline --without-zlib

# å¯ç”¨è°ƒè¯•å’ŒæŒ‡å®šç¼–è¯‘å™¨
./configure --enable-debug --with-pgport=5432 CC=gcc CFLAGS='-O2 -g'
```

| é€‰é¡¹                   | æè¿°                                                         |
| :--------------------- | :----------------------------------------------------------- |
| `--prefix=<ç›®å½•>`      | æŒ‡å®šå®‰è£…ç›®å½•çš„å‰ç¼€ï¼Œå³ PostgreSQL å°†è¢«å®‰è£…åˆ°çš„åŸºæœ¬ç›®å½•ã€‚     |
| `--bindir=<ç›®å½•>`      | æŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚ `pg_ctl` å’Œ `psql`ã€‚               |
| `--sbindir=<ç›®å½•>`     | æŒ‡å®šç³»ç»Ÿç®¡ç†å‘˜å¯æ‰§è¡Œæ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚ `pg_ctl` å’Œ `pg_config`ã€‚ |
| `--datadir=<ç›®å½•>`     | æŒ‡å®šæ•°æ®æ–‡ä»¶çš„æ ¹ç›®å½•ï¼Œä¾‹å¦‚æ•°æ®è¡¨ç©ºé—´ã€‚                       |
| `--libdir=<ç›®å½•>`      | æŒ‡å®šåº“æ–‡ä»¶çš„ç›®å½•ï¼Œä¾‹å¦‚å…±äº«åº“æ–‡ä»¶ã€‚                           |
| `--sysconfdir=<ç›®å½•>`  | æŒ‡å®šé…ç½®æ–‡ä»¶çš„ç›®å½•ã€‚                                         |
| `--docdir=<ç›®å½•>`      | æŒ‡å®šæ–‡æ¡£æ–‡ä»¶çš„ç›®å½•ã€‚                                         |
| `--includedir=<ç›®å½•>`  | æŒ‡å®šåŒ…å«å¤´æ–‡ä»¶çš„ç›®å½•ï¼Œç”¨äºå¼€å‘ PostgreSQL æ‰©å±•ã€‚             |
| `--with-openssl`       | å¯ç”¨ OpenSSL æ”¯æŒï¼Œç”¨äºåŠ å¯†é€šä¿¡ã€‚                            |
| `--with-zlib`          | å¯ç”¨ Zlib æ”¯æŒï¼Œç”¨äºæ•°æ®å‹ç¼©ã€‚                               |
| `--with-libxml`        | å¯ç”¨ Libxml2 æ”¯æŒï¼Œç”¨äº XML æ•°æ®ç±»å‹ã€‚                       |
| `--with-python`        | å¯ç”¨ Python æ”¯æŒï¼Œç”¨äºç¼–å†™å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨ã€‚                 |
| `--with-perl`          | å¯ç”¨ Perl æ”¯æŒï¼Œç”¨äºç¼–å†™å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨ã€‚                   |
| `--with-tcl`           | å¯ç”¨ Tcl æ”¯æŒï¼Œç”¨äºç¼–å†™å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨ã€‚                    |
| `--with-pam`           | å¯ç”¨ PAM (Pluggable Authentication Modules) æ”¯æŒã€‚           |
| `--with-ldap`          | å¯ç”¨ LDAP æ”¯æŒï¼Œç”¨äºèº«ä»½éªŒè¯å’Œç”¨æˆ·ç®¡ç†ã€‚                     |
| `--with-krb5`          | å¯ç”¨ Kerberos æ”¯æŒï¼Œç”¨äºèº«ä»½éªŒè¯ã€‚                           |
| `--with-system-tzdata` | ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„æ—¶åŒºä¿¡æ¯ã€‚                                 |
| `--enable-debug`       | å¯ç”¨è°ƒè¯•æ”¯æŒï¼Œæ„å»ºæ—¶åŒ…æ‹¬è°ƒè¯•ä¿¡æ¯ã€‚                           |
| `--disable-ipv6`       | ç¦ç”¨ IPv6 æ”¯æŒã€‚                                             |

#### 4. æ„å»ºäºŒè¿›åˆ¶

å¯ä»¥è¾“å…¥ä»¥ä¸‹ä»»ä¸€å‘½ä»¤å¼€å§‹æ„å»ºï¼Œå¯ä»¥ä½¿ç”¨ -j é€‰é¡¹æŒ‡å®šçº¿ç¨‹æ•°åŠ å¿«é€Ÿåº¦ã€‚

```shell
make

# å¤šçº¿ç¨‹æ„å»º
make -j 8 
```

å¦‚æœä½ æƒ³æ„å»ºæ‰€æœ‰å¯ä»¥æ„å»ºçš„å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡æ¡£ï¼ˆHTML å’Œ man é¡µé¢ï¼‰å’Œé™„åŠ æ¨¡å—ï¼ˆcontribï¼‰ï¼Œåˆ™å¯ä»¥è¾“å…¥ï¼š

```shell
make world
```

æˆ–è€…å¦‚æœä½ æƒ³æ„å»ºæ‰€æœ‰å¯ä»¥æ„å»ºçš„å†…å®¹ï¼ŒåŒ…æ‹¬é™„åŠ æ¨¡å—ï¼ˆcontribï¼‰ï¼Œä½†ä¸åŒ…æ‹¬æ–‡æ¡£ï¼Œå¯ä»¥è¾“å…¥ï¼š

```shell
make world-bin
```

#### 5. æµ‹è¯•è½¯ä»¶

å¦‚æœä½ æƒ³åœ¨å®‰è£…ä¹‹å‰æµ‹è¯•æ–°æ„å»ºçš„æœåŠ¡å™¨ï¼Œä½ å¯ä»¥åœ¨æ­¤æ—¶è¿è¡Œå›å½’æµ‹è¯•ã€‚è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯ PostgreSQL æ˜¯å¦æŒ‰ç…§å¼€å‘äººå‘˜é¢„æœŸçš„æ–¹å¼åœ¨ä½ çš„æœºå™¨ä¸Šè¿è¡Œã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæµ‹è¯•ï¼š

```shell
make check
```

#### 6. å®‰è£…

è¦å®‰è£… PostgreSQLï¼Œå¯ä»¥è¾“å…¥ï¼š

```shell
make install
```

æ­¤æ­¥éª¤å°†æŠŠæ–‡ä»¶å®‰è£…åˆ°ç¬¬ä¸€æ­¥ä¸­æŒ‡å®šçš„ç›®å½•ä¸­ã€‚**ç¡®ä¿ä½ æœ‰é€‚å½“çš„æƒé™å†™å…¥è¯¥åŒºåŸŸã€‚**æˆ–è€…ï¼Œä½ å¯ä»¥æå‰åˆ›å»ºç›®æ ‡ç›®å½•å¹¶å®‰æ’æˆäºˆé€‚å½“çš„æƒé™ã€‚

å¦‚æœä½ æ„å»ºäº†ä¸Šé¢çš„ worldï¼Œå¯ä»¥è¾“å…¥ï¼š

```shell
make install-world
```

è¿™ä¹Ÿä¼šå®‰è£…æ–‡æ¡£ã€‚å¦‚æœä½ åœ¨ä¸Šé¢æ„å»ºäº†ä¸åŒ…å«æ–‡æ¡£çš„ worldï¼Œå¯ä»¥è¾“å…¥ï¼š

```shell
make install-world-bin
```

#### 7. é…ç½®è½¯è¿

è®¾ç½® postgres è½¯é“¾æ¥ï¼Œæ–¹ä¾¿ç³»ç»Ÿåç»­å‡çº§ã€‚

```shell
ln -s /opt/postgres/pg16 /opt/postgresql/pgsql
```

#### 8. å¸è½½å’Œæ¸…ç†

å¦‚æœè¦æ’¤é”€å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ `make uninstall`ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ä¼šåˆ é™¤ä»»ä½•åˆ›å»ºçš„ç›®å½•ã€‚

å®‰è£…åï¼Œä½ å¯ä»¥é€šè¿‡ä»æºä»£ç æ ‘ä¸­åˆ é™¤æ„å»ºæ–‡ä»¶æ¥é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œå‘½ä»¤æ˜¯ `make clean`ã€‚è¿™å°†ä¿ç•™ `configure` ç¨‹åºåˆ›å»ºçš„æ–‡ä»¶ï¼Œä»¥ä¾¿ä½ ç¨åå¯ä»¥ä½¿ç”¨ `make` é‡æ–°æ„å»ºæ‰€æœ‰å†…å®¹ã€‚è¦å°†æºä»£ç æ ‘é‡ç½®ä¸ºåˆ†å‘æ—¶çš„çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ `make distclean`ã€‚

### äºŒè¿›åˆ¶å®‰è£…

#### 1. ä¸‹è½½

åœ¨å¼€å§‹äºŒè¿›åˆ¶å®‰è£…ä¹‹å‰ï¼Œä½ éœ€è¦é¦–å…ˆä¸‹è½½é€‚ç”¨äºä½ çš„æ“ä½œç³»ç»Ÿçš„ PostgreSQL äºŒè¿›åˆ¶åŒ…ã€‚ä½ å¯ä»¥ä» PostgreSQL å®˜æ–¹ç½‘ç«™æˆ–è€…ä½ çš„æ“ä½œç³»ç»Ÿçš„è½¯ä»¶åº“ä¸­è·å–å®ƒã€‚

```shell
# é€šè¿‡ wget å‘½ä»¤ä¸‹è½½
wget https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# é€šè¿‡ curl å‘½ä»¤ä¸‹è½½
curl -O https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
```

#### 2. å®‰è£…

å®‰è£…äºŒè¿›åˆ¶åŒ…é€šå¸¸æ¯”æºç å®‰è£…æ›´å¿«æ›´ç®€å•ã€‚æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿå’ŒåŒ…ç®¡ç†å™¨ï¼Œè¿™é‡Œä»‹ç»å‡ ç§å¸¸ç”¨çš„å®‰è£…æ–¹æ³•ï¼š

```shell
# åœ¨ Red Hat/CentOS ä¸­å®‰è£…
sudo rpm -ivh pgdg-redhat-repo-latest.noarch.rpm
sudo yum install postgresql-server

# åœ¨ Debian/Ubuntu ä¸­å®‰è£…
sudo apt-get update
sudo apt-get install postgresql

# åœ¨ Debian/Ubuntu ä¸­ä½¿ç”¨è‡ªå®šä¹‰é€‰é¡¹è¿›è¡Œå®‰è£…
sudo apt install postgresql --prefix=/usr/local/pgsql --datadir=/usr/local/pgsql/data

# åœ¨ Red Hat/CentOS ä¸­ä½¿ç”¨è‡ªå®šä¹‰é€‰é¡¹è¿›è¡Œå®‰è£…
sudo yum install postgresql-server --prefix=/usr/local/pgsql --datadir=/usr/local/pgsql/data
```

å®‰è£…è¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹æ¥è‡ªå®šä¹‰å®‰è£…ï¼š

| é€‰é¡¹                    | æè¿°                                               |
| ----------------------- | -------------------------------------------------- |
| `--prefix=PREFIX`       | å®šä¹‰å®‰è£…çš„æ ¹ç›®å½•ï¼Œæ‰€æœ‰æ–‡ä»¶å’Œç›®å½•éƒ½å°†æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ |
| `--exec-prefix=EPREFIX` | å®šä¹‰æ¶æ„ç›¸å…³æ–‡ä»¶çš„å®‰è£…ç›®å½•ï¼Œé€šå¸¸ä¸ `--prefix` ç›¸åŒ |
| `--bindir=DIR`          | å®šä¹‰ç”¨æˆ·å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚ psqlï¼‰çš„å®‰è£…ç›®å½•            |
| `--datadir=DIR`         | å®šä¹‰åªè¯»æ¶æ„ç‹¬ç«‹æ•°æ®çš„å®‰è£…ç›®å½•                     |
| `--libdir=DIR`          | å®šä¹‰åº“æ–‡ä»¶çš„å®‰è£…ç›®å½•                               |
| `--sysconfdir=DIR`      | å®šä¹‰ç³»ç»Ÿçº§é…ç½®æ–‡ä»¶çš„å®‰è£…ç›®å½•                       |
| `--sharedstatedir=DIR`  | å®šä¹‰å¯ä¿®æ”¹çš„å•ä¸»æœºæ•°æ®çš„å®‰è£…ç›®å½•                   |
| `--localstatedir=DIR`   | å®šä¹‰å¯ä¿®æ”¹çš„å¤šä¸»æœºæ•°æ®çš„å®‰è£…ç›®å½•                   |
| `--libexecdir=DIR`      | å®šä¹‰å¯æ‰§è¡Œç¨‹åºå’Œå…¶ä»–ç¨‹åºè¿è¡Œçš„å®‰è£…ç›®å½•             |
| `--includedir=DIR`      | å®šä¹‰ C å¤´æ–‡ä»¶çš„å®‰è£…ç›®å½•                              |
| `--mandir=DIR`          | å®šä¹‰ man æ–‡æ¡£çš„å®‰è£…ç›®å½•                            |
| `--docdir=DIR`          | å®šä¹‰æ–‡æ¡£çš„æ ¹ç›®å½•                                   |

#### 3. éªŒè¯

å®‰è£…å®Œæˆåï¼ŒéªŒè¯ PostgreSQL æ˜¯å¦å·²æˆåŠŸå®‰è£…å’Œé…ç½®ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥éªŒè¯å®‰è£…ï¼š

```shell
# æ£€æŸ¥ PostgreSQL æœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# ä½¿ç”¨ psql å‘½ä»¤è¡Œå·¥å…·è¿æ¥åˆ° PostgreSQL æœåŠ¡å™¨
psql -U postgres

# æ˜¾ç¤º PostgreSQL æœåŠ¡å™¨çš„ç‰ˆæœ¬ä¿¡æ¯
psql -U postgres -c 'SELECT version();'
```

äºŒè¿›åˆ¶å®‰è£…æˆåŠŸåï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œé»˜è®¤ä¸éœ€è¦åç»­çš„é…ç½®ã€‚

## è®¾ç½®

### 1. å…±äº«åº“è®¾ç½® (Shared Libraries)

åœ¨æŸäº›ç³»ç»Ÿä¸­ï¼Œä½ éœ€è¦å‘Šè¯‰ç³»ç»Ÿå¦‚ä½•æ‰¾åˆ°æ–°å®‰è£…çš„å…±äº«åº“ã€‚è¿™ä¸åŒ…æ‹¬ FreeBSD, HP-UX, Linux, NetBSD, OpenBSD å’Œ Solaris ç­‰ç³»ç»Ÿã€‚è®¾ç½®å…±äº«åº“æœç´¢è·¯å¾„çš„æ–¹æ³•å› å¹³å°è€Œå¼‚ï¼Œä½†æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯è®¾ç½®ç¯å¢ƒå˜é‡ `LD_LIBRARY_PATH`ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Bourne shell (å¦‚ sh, ksh, bash, zsh) ä¸­è®¾ç½®ï¼š

```shell
LD_LIBRARY_PATH=/usr/local/pgsql/lib
export LD_LIBRARY_PATH
```

### 2. ç¯å¢ƒå˜é‡è®¾ç½® (Environment Variables)

å¦‚æœä½ å°† PostgreSQL å®‰è£…åˆ° `/usr/local/pgsql` æˆ–å…¶ä»–é»˜è®¤æƒ…å†µä¸‹ä¸æœç´¢ç¨‹åºçš„ä½ç½®ï¼Œä½ åº”è¯¥å°† `/usr/local/pgsql/bin`ï¼ˆæˆ–ä½ åœ¨ç¬¬ä¸€æ­¥ä¸­è®¾ç½®çš„ `--bindir` é€‰é¡¹ï¼‰æ·»åŠ åˆ°ä½ çš„ `PATH` ä¸­ã€‚è¿™æ ·å¯ä»¥ä½¿ PostgreSQL çš„ä½¿ç”¨æ›´åŠ æ–¹ä¾¿ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Bourne shell ä¸­è®¾ç½®ï¼š

```shell
PATH=/usr/local/pgsql/bin:$PATH
export PATH
```

ä¸ºäº†è®©ä½ çš„ç³»ç»Ÿæ‰¾åˆ° man æ–‡æ¡£ï¼Œä½ éœ€è¦å°†ä»¥ä¸‹è¡Œæ·»åŠ åˆ°ä¸€ä¸ª shell å¯åŠ¨æ–‡ä»¶ä¸­ï¼Œé™¤éä½ å®‰è£…åˆ°äº†é»˜è®¤æœç´¢çš„ä½ç½®ï¼š

```shell
MANPATH=/usr/local/pgsql/share/man:$MANPATH
export MANPATH
```

ç¯å¢ƒå˜é‡ `PGHOST` å’Œ `PGPORT` æŒ‡å®šäº†æ•°æ®åº“æœåŠ¡å™¨çš„ä¸»æœºå’Œç«¯å£ï¼Œè¦†ç›–äº†ç¼–è¯‘æ—¶çš„é»˜è®¤è®¾ç½®ã€‚å¦‚æœä½ æ‰“ç®—è¿œç¨‹è¿è¡Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºï¼Œé‚£ä¹ˆæ¯ä¸ªè®¡åˆ’ä½¿ç”¨æ•°æ®åº“çš„ç”¨æˆ·éƒ½åº”è®¾ç½® `PGHOST`ã€‚è¿™ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†å¯ä»¥é€šè¿‡å¤§å¤šæ•°å®¢æˆ·ç«¯ç¨‹åºçš„å‘½ä»¤è¡Œé€‰é¡¹æ¥ä¼ é€’è®¾ç½®ã€‚

### 3. é…ç½®è„šæœ¬ç¤ºä¾‹

```shell
#!/bin/bash

# å°†é…ç½®å†™å…¥ ~/.bash_profile æ–‡ä»¶
cat >> ~/.bash_profile <<EOF
export PGDATA=/opt/postgres/data
export PGHOME=/opt/postgres/pgsql
export LD_LIBRARY_PATH=$pg_home/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH
export PATH=$pg_home/bin:$PATH:.
export MANPATH=$pg_home/share/man:$MANPATH
export PGHOST=$PGDATA
export PGUSER=postgres
export PGDATABASE=postgres
EOF

# é‡æ–°åŠ è½½ ~/.bash_profile
source ~/.bash_profile
```

## ä½¿ç”¨

### Psql å‘½ä»¤

| å†…ç½®å‘½ä»¤        | ä½œç”¨æè¿°                                         |
| --------------- | ------------------------------------------------ |
| `\q`            | é€€å‡º psql                                        |
| `\l` æˆ– `\list` | åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“                                   |
| `\c [æ•°æ®åº“å]` | è¿æ¥åˆ°æ–°æ•°æ®åº“                                   |
| `\dt`           | åˆ—å‡ºå½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨                         |
| `\d [è¡¨å]`     | æ˜¾ç¤ºè¡¨çš„ç»“æ„ï¼ˆåˆ—ã€æ•°æ®ç±»å‹ã€æƒé™ç­‰ï¼‰             |
| `\du`           | åˆ—å‡ºæ‰€æœ‰ PostgreSQL ç”¨æˆ·è§’è‰²                     |
| `\e`            | æ‰“å¼€æ–‡æœ¬ç¼–è¾‘å™¨                                   |
| `\a`            | åˆ‡æ¢è¾“å‡ºæ ¼å¼ï¼ˆå¯¹é½æˆ–éå¯¹é½ï¼‰                     |
| `\x`            | åˆ‡æ¢æ‰©å±•æ˜¾ç¤ºæ¨¡å¼                                 |
| `\timing`       | æ˜¾ç¤º SQL æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´                          |
| `\i [æ–‡ä»¶å]`   | æ‰§è¡Œæ–‡ä»¶ä¸­çš„ SQL å‘½ä»¤                            |
| `\o [æ–‡ä»¶å]`   | å°†æŸ¥è¯¢ç»“æœè¾“å‡ºåˆ°æ–‡ä»¶                             |
| `\s`            | æ˜¾ç¤ºå‘½ä»¤å†å²                                     |
| `\?`            | æ˜¾ç¤ºæ‰€æœ‰ psql å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯                     |
| `\h [SQLå‘½ä»¤]`  | æ˜¾ç¤º SQL å‘½ä»¤çš„è¯­æ³•å’Œé€‰é¡¹                        |
| `\set`          | åˆ—å‡ºæ‰€æœ‰ psql å˜é‡åŠå…¶å€¼                         |
| `\unset`        | åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª psql å˜é‡                         |
| `\g` æˆ– `;`     | æ‰§è¡ŒæŸ¥è¯¢                                         |
| `\qecho [æ–‡æœ¬]` | åœ¨è¾“å‡ºä¸­æ˜¾ç¤ºæ–‡æœ¬ï¼ˆé€šå¸¸ç”¨äºè„šæœ¬ä¸­æ·»åŠ æ³¨é‡Šæˆ–ç©ºè¡Œï¼‰ |
| `\conninfo`     | æ˜¾ç¤ºå½“å‰æ•°æ®åº“è¿æ¥çš„è¯¦ç»†ä¿¡æ¯                     |

### 1. åˆå§‹åŒ–æ•°æ®åº“ç›®å½•

é¦–å…ˆï¼Œéœ€è¦ä½¿ç”¨ `initdb` å‘½ä»¤æ¥åˆå§‹åŒ–æ•°æ®åº“ç›®å½•ã€‚è¯¥å‘½ä»¤ä¼šåˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„å’Œç³»ç»Ÿç›®å½•ï¼Œä»¥ä¾¿ PostgreSQL æ•°æ®åº“èƒ½å¤Ÿè¿è¡Œã€‚

```shell
# -D é€‰é¡¹æŒ‡å®šæ•°æ®åº“ç›®å½•çš„è·¯å¾„
initdb -D /path/to/data/directory
```

### 2. é…ç½®æ–‡ä»¶

#### postgresql.conf

PostgreSQL çš„ä¸»é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®å„ç§å‚æ•°ï¼Œå¦‚å†…å­˜ä½¿ç”¨ã€è¿æ¥æ•°ç­‰ã€‚ä¸‹é¢æ˜¯å¸¸ç”¨é…ç½®ï¼š

| é…ç½®é€‰é¡¹                          | ä½œç”¨                                       | ç¤ºä¾‹é…ç½®                                          |
| --------------------------------- | ------------------------------------------ | ------------------------------------------------- |
| **è¿æ¥è®¾ç½®**                      |                                            |                                                   |
| `listen_addresses`                | å®šä¹‰æœåŠ¡å™¨ç›‘å¬çš„åœ°å€                       | `listen_addresses = '*'`                          |
| `port`                            | å®šä¹‰æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£                       | `port = 5432`                                     |
| `max_connections`                 | æœ€å¤§å¹¶å‘è¿æ¥æ•°                             | `max_connections = 100`                           |
| `superuser_reserved_connections`  | ä¸ºè¶…çº§ç”¨æˆ·ä¿ç•™çš„è¿æ¥æ•°                     | `superuser_reserved_connections = 3`              |
| `unix_socket_directories`         | Unix åŸŸå¥—æ¥å­—çš„ç›®å½•                         | `unix_socket_directories = '/var/run/postgresql'` |
| **è®¤è¯å’Œå®‰å…¨**                    |                                            |                                                   |
| `ssl`                             | æ˜¯å¦å¯ç”¨ SSL                                | `ssl = on`                                        |
| `ssl_cert_file`                   | SSL è¯ä¹¦æ–‡ä»¶çš„ä½ç½®                          | `ssl_cert_file = '/path/to/server.crt'`           |
| `ssl_key_file`                    | SSL ç§é’¥æ–‡ä»¶çš„ä½ç½®                          | `ssl_key_file = '/path/to/server.key'`            |
| `password_encryption`             | å¯†ç åŠ å¯†æ–¹å¼                               | `password_encryption = scram-sha-256`             |
| `hba_file`                        | `pg_hba.conf` æ–‡ä»¶çš„ä½ç½®                   | `hba_file = '/path/to/pg_hba.conf'`               |
| **å†…å­˜ä½¿ç”¨**                      |                                            |                                                   |
| `shared_buffers`                  | ç”¨äºç¼“å­˜çš„å†…å­˜å¤§å°                         | `shared_buffers = 128MB`                          |
| `work_mem`                        | æŸ¥è¯¢æ“ä½œå¯ä»¥ä½¿ç”¨çš„å†…å­˜é‡                   | `work_mem = 4MB`                                  |
| `maintenance_work_mem`            | ç»´æŠ¤æ“ä½œï¼ˆå¦‚ VACUUMï¼‰å¯ä»¥ä½¿ç”¨çš„å†…å­˜é‡       | `maintenance_work_mem = 64MB`                     |
| `effective_cache_size`            | ä¼°è®¡çš„æ“ä½œç³»ç»Ÿç¼“å­˜å¤§å°                     | `effective_cache_size = 512MB`                    |
| **æŸ¥è¯¢è°ƒä¼˜**                      |                                            |                                                   |
| `seq_page_cost`                   | é¡ºåºç£ç›˜é¡µçš„æˆæœ¬                           | `seq_page_cost = 1.0`                             |
| `random_page_cost`                | éšæœºç£ç›˜é¡µçš„æˆæœ¬                           | `random_page_cost = 4.0`                          |
| `cpu_tuple_cost`                  | å¤„ç†æ¯ä¸ªå…ƒç»„çš„ CPU æˆæœ¬                      | `cpu_tuple_cost = 0.01`                           |
| `cpu_index_tuple_cost`            | å¤„ç†æ¯ä¸ªç´¢å¼•å…ƒç»„çš„ CPU æˆæœ¬                  | `cpu_index_tuple_cost = 0.005`                    |
| `cpu_operator_cost`               | æ‰§è¡Œæ“ä½œç¬¦çš„ CPU æˆæœ¬                        | `cpu_operator_cost = 0.0025`                      |
| **æ—¥å¿—è®°å½•**                      |                                            |                                                   |
| `logging_collector`               | æ˜¯å¦å¯ç”¨æ—¥å¿—æ”¶é›†                           | `logging_collector = on`                          |
| `log_directory`                   | æ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨ç›®å½•                         | `log_directory = 'pg_log'`                        |
| `log_filename`                    | æ—¥å¿—æ–‡ä»¶çš„å‘½åæ–¹å¼                         | `log_filename = 'postgresql.log'`                 |
| `log_statement`                   | è®°å½•çš„ SQL è¯­å¥ç±»å‹ï¼ˆä¾‹å¦‚æ‰€æœ‰è¯­å¥æˆ–åªæœ‰ DDLï¼‰ | `log_statement = 'all'`                           |
| `log_duration`                    | æ˜¯å¦è®°å½•è¯­å¥çš„æ‰§è¡Œæ—¶é—´                     | `log_duration = on`                               |
| `log_min_duration_statement`      | è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šæ¯«ç§’æ•°çš„è¯­å¥           | `log_min_duration_statement = 500`                |
| **è¿è¡Œæ—¶ç»Ÿè®¡**                    |                                            |                                                   |
| `track_activities`                | æ˜¯å¦è·Ÿè¸ªæœåŠ¡å™¨è¿›ç¨‹çš„æ´»åŠ¨                   | `track_activities = on`                           |
| `track_counts`                    | æ˜¯å¦è·Ÿè¸ªè®¿é—®ç»Ÿè®¡ä¿¡æ¯                       | `track_counts = on`                               |
| `track_io_timing`                 | æ˜¯å¦è·Ÿè¸ª I/O è®¡æ—¶ä¿¡æ¯                        | `track_io_timing = on`                            |
| `stats_temp_directory`            | ä¸´æ—¶ç»Ÿè®¡æ•°æ®çš„ç›®å½•                         | `stats_temp_directory = 'pg_stat_tmp'`            |
| **é”å®š**                          |                                            |                                                   |
| `deadlock_timeout`                | æ­»é”æ£€æµ‹çš„è¶…æ—¶æ—¶é—´                         | `deadlock_timeout = 1s`                           |
| `max_locks_per_transaction`       | æ¯ä¸ªäº‹åŠ¡å¯ä»¥æŒæœ‰çš„æœ€å¤§é”æ•°                 | `max_locks_per_transaction = 64`                  |
| **è‡ªåŠ¨ VACUUM**                   |                                            |                                                   |
| `autovacuum`                      | æ˜¯å¦å¯ç”¨è‡ªåŠ¨ VACUUM                         | `autovacuum = on`                                 |
| `autovacuum_vacuum_scale_factor`  | è§¦å‘è‡ªåŠ¨ VACUUM çš„è„æ•°æ®æ¯”ä¾‹                 | `autovacuum_vacuum_scale_factor = 0.2`            |
| `autovacuum_analyze_scale_factor` | è§¦å‘è‡ªåŠ¨ ANALYZE çš„è„æ•°æ®æ¯”ä¾‹                | `autovacuum_analyze_scale_factor = 0.1`           |
| `autovacuum_vacuum_cost_limit`    | è‡ªåŠ¨ VACUUM æ“ä½œçš„æˆæœ¬é™åˆ¶                   | `autovacuum_vacuum_cost_limit = 200`              |
| **å®¢æˆ·ç«¯è¿æ¥é»˜è®¤å€¼**              |                                            |                                                   |
| `DateStyle`                       | é»˜è®¤çš„æ—¥æœŸæ ¼å¼                             | `DateStyle = 'ISO, MDY'`                          |
| `TimeZone`                        | é»˜è®¤çš„æ—¶åŒº                                 | `TimeZone = 'UTC'`                                |
| `lc_messages`                     | æ¶ˆæ¯çš„æœ¬åœ°åŒ–è®¾ç½®                           | `lc_messages = 'en_US.UTF-8'`                     |
| `lc_monetary`                     | è´§å¸æ ¼å¼çš„æœ¬åœ°åŒ–è®¾ç½®                       | `lc_monetary = 'en_US.UTF-8'`                     |
| `lc_numeric`                      | æ•°å­—æ ¼å¼çš„æœ¬åœ°åŒ–è®¾ç½®                       | `lc_numeric = 'en_US.UTF-8'`                      |
| `lc_time`                         | æ—¶é—´å’Œæ—¥æœŸæ ¼å¼çš„æœ¬åœ°åŒ–è®¾ç½®                 | `lc_time = 'en_US.UTF-8'`                         |
| **LOCALE**                        |                                            |                                                   |
| `lc_collate`                      | å­—ç¬¦ä¸²æ’åºçš„æœ¬åœ°åŒ–è®¾ç½®                     | `lc_collate = 'en_US.UTF-8'`                      |
| `lc_ctype`                        | å­—ç¬¦åˆ†ç±»çš„æœ¬åœ°åŒ–è®¾ç½®                       | `lc_ctype = 'en_US.UTF-8'`                        |

#### pg_hba.conf

`pg_hba.conf` æ–‡ä»¶ç”¨äºæ§åˆ¶å“ªäº›å®¢æˆ·ç«¯å¯ä»¥è¿æ¥åˆ°æ•°æ®åº“ï¼Œä»¥åŠå®ƒä»¬å¯ä»¥ä½¿ç”¨çš„è®¤è¯æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯ `pg_hba.conf` ä¸­çš„å¸¸è§é…ç½®é¡¹ã€ä½œç”¨å’Œç¤ºä¾‹é…ç½®ï¼š

| ç±»å‹        | æ•°æ®åº“ | ç”¨æˆ·     | åœ°å€             | è®¤è¯æ–¹æ³• | è¯´æ˜                                         |
| ----------- | ------ | -------- | ---------------- | -------- | -------------------------------------------- |
| `local`     | `all`  | `all`    |                  | `trust`  | æœ¬åœ°æ‰€æœ‰ç”¨æˆ·å¯¹æ‰€æœ‰æ•°æ®åº“çš„è¿æ¥ä¸éœ€è¦å¯†ç      |
| `host`      | `all`  | `all`    | `127.0.0.1/32`   | `md5`    | ä»æœ¬åœ°é€šè¿‡ TCP/IP è¿æ¥çš„æ‰€æœ‰ç”¨æˆ·éœ€è¦å¯†ç        |
| `host`      | `mydb` | `myuser` | `192.168.1.0/24` | `md5`    | ä»æŒ‡å®šç½‘ç»œè¿æ¥åˆ°æŒ‡å®šæ•°æ®åº“çš„æŒ‡å®šç”¨æˆ·éœ€è¦å¯†ç  |
| `hostssl`   | `all`  | `all`    | `0.0.0.0/0`      | `md5`    | ä»ä»»ä½•åœ°å€é€šè¿‡ SSL è¿æ¥çš„æ‰€æœ‰ç”¨æˆ·éœ€è¦å¯†ç       |
| `hostnossl` | `all`  | `all`    | `0.0.0.0/0`      | `reject` | æ‹’ç»é SSL è¿æ¥                                |

- **ç±»å‹**ï¼šè¿æ¥ç±»å‹ã€‚å¸¸è§çš„æœ‰ `local`ï¼ˆUnix åŸŸå¥—æ¥å­—ï¼‰ã€`host`ï¼ˆTCP/IP å¥—æ¥å­—ï¼‰ã€`hostssl`ï¼ˆä»…é™ SSL çš„ TCP/IP è¿æ¥ï¼‰å’Œ `hostnossl`ï¼ˆä¸ä½¿ç”¨ SSL çš„ TCP/IP è¿æ¥ï¼‰ã€‚
- **æ•°æ®åº“**ï¼šé€‚ç”¨çš„æ•°æ®åº“åã€‚`all` è¡¨ç¤ºæ‰€æœ‰æ•°æ®åº“ã€‚
- **ç”¨æˆ·**ï¼šé€‚ç”¨çš„ç”¨æˆ·åã€‚`all` è¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·ã€‚
- **åœ°å€**ï¼šå®¢æˆ·ç«¯çš„ IP åœ°å€ã€‚å¯¹äº `local` ç±»å‹ï¼Œè¿™ä¸€åˆ—æ˜¯ç©ºçš„ã€‚å¯¹äº `host` ç±»å‹ï¼Œè¿™æ˜¯ä¸€ä¸ª CIDR åœ°å€æˆ–ä¸€ä¸ª IP åœ°å€å’Œä¸€ä¸ªæ©ç ã€‚
- **è®¤è¯æ–¹æ³•**ï¼šå¸¸è§çš„æœ‰ `trust`ï¼ˆä¸éœ€è¦å¯†ç ï¼‰ã€`reject`ï¼ˆæ‹’ç»è¿æ¥ï¼‰ã€`md5`ï¼ˆå¯†ç è®¤è¯ï¼‰ã€`password`ï¼ˆæ˜æ–‡å¯†ç ï¼‰ç­‰ã€‚

`pg_hba.conf` æ–‡ä»¶çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªè¿æ¥è§„åˆ™ï¼ŒPostgreSQL ä¼šæŒ‰ç…§æ–‡ä»¶ä¸­çš„é¡ºåºè¯„ä¼°è¿™äº›è§„åˆ™ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ä¸ºæ­¢ã€‚å› æ­¤ï¼Œé¡ºåºå¾ˆé‡è¦ï¼Œç‰¹åˆ«æ˜¯å½“æœ‰å¤šä¸ªè§„åˆ™å¯èƒ½åŒ¹é…åŒä¸€ä¸ªè¿æ¥æ—¶ã€‚

### 3. å¯åŠ¨æ•°æ®åº“

ä¸€æ—¦æ•°æ®åº“ç›®å½•è¢«æˆåŠŸåˆå§‹åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ `pg_ctl` å‘½ä»¤æ¥å¯åŠ¨ PostgreSQL æ•°æ®åº“ã€‚

```shell
# -D é€‰é¡¹æŒ‡å®šäº†æ•°æ®åº“ç›®å½•çš„è·¯å¾„ã€‚
pg_ctl start -D /path/to/data/directory
# æˆ–è€…
postgres -D /path/to/data/directory
```

### 4. éªŒè¯æ•°æ®åº“æ˜¯å¦æ­£åœ¨è¿è¡Œ

ä¸ºäº†éªŒè¯ PostgreSQL æ•°æ®åº“æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ `psql` å‘½ä»¤è¿æ¥åˆ°æ•°æ®åº“å¹¶æ‰§è¡Œä¸€ä¸ªç®€å•çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼š

```shell
psql -U postgres -c "SELECT version();"
```

### 5. é…ç½® Systemctl æœåŠ¡

1. å…³é—­ postgresql æ•°æ®åº“ã€‚
2. åˆ›å»ºä¸€ä¸ª Systemd æœåŠ¡æ–‡ä»¶ï¼Œé€šå¸¸ä½äº `/etc/systemd/system/postgresql.service`ã€‚
3. æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆéœ€è¦ç»“åˆé…ç½®è„šæœ¬ç¤ºä¾‹ï¼‰ã€‚

```shell
[Unit]
Description=PostgreSQL database server
Documentation=man:postgres(1)
After=network.target

[Service]
Type=forking
User=postgres
Group=postgres
Environment=PGPORT=5432
Environment=PGDATA=/opt/postgresql/data
OOMScoreAdjust=-1000
ExecStart=/opt/postgresql/pgsql/bin/pg_ctl start -D ${PGDATA} -s -o "-p ${PGPORT}" -w -t 300
ExecStop=/opt/postgresql/pgsql/bin/pg_ctl stop -D ${PGDATA} -s -m fast
ExecReload=/opt/postgresql/pgsql//bin/pg_ctl reload -D ${PGDATA} -s
KillMode=mixed
KillSignal=SIGINT
TimeoutSec=30

[Install]
WantedBy=multi-user.target
```

1. é‡æ–°åŠ è½½ Systemd é…ç½®ï¼š`sudo systemctl daemon-reload`
2. å¯åŠ¨æœåŠ¡ï¼š`sudo systemctl start postgresql`
3. è®¾ç½®å¼€æœºå¯åŠ¨ï¼š`sudo systemctl enable postgresql`

### 6. åˆ›å»ºç”¨æˆ·å’Œæ•°æ®åº“

```shell
# åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·
sudo -u postgres createuser -P <username>

# åˆ›å»ºä¸€ä¸ªæ–°æ•°æ®åº“
sudo -u postgres createdb -O <username> <dbname>

# ä¸ºç”¨æˆ·åˆ†é…ç‰¹å®šæƒé™
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE <dbname> TO <username>;"
```

### 7. ç”¨æˆ·å’Œè§’è‰²ç®¡ç†

```shell
# åˆ›å»ºè§’è‰²
sudo -u postgres createuser <role_name>

# ä¸ºè§’è‰²åˆ†é…æƒé™
sudo -u postgres psql -c "GRANT <permission> ON <object> TO <role_name>;"

# åˆ é™¤è§’è‰²
sudo -u postgres dropuser <role_name>

# è®¾ç½®å¯†ç ç­–ç•¥å’ŒéªŒè¯
sudo -u postgres psql -c "ALTER USER <username> WITH PASSWORD '<password>';"
```

### 8. å¤‡ä»½å’Œæ¢å¤

å¤‡ä»½å’Œæ¢å¤æ˜¯æ•°æ®åº“ç®¡ç†çš„å…³é”®éƒ¨åˆ†ï¼Œç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œå®Œæ•´æ€§ã€‚PostgreSQL æä¾›äº† `pg_dump` å’Œ `pg_restore` å·¥å…·æ¥å¸®åŠ©ç®¡ç†å‘˜è¿›è¡Œè¿™äº›æ“ä½œã€‚

#### `pg_dump` å¤‡ä»½

`pg_dump` æ˜¯ç”¨äºå¤‡ä»½ PostgreSQL æ•°æ®åº“çš„å·¥å…·ã€‚å®ƒå¯ä»¥ç”ŸæˆåŒ…å«æ•°æ®åº“å†…å®¹çš„ SQL è„šæœ¬æ–‡ä»¶æˆ–å…¶ä»–æ ¼å¼ï¼Œå¦‚ tar å’Œ customã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œå…¨é‡å¤‡ä»½ï¼š

```shell
pg_dump -U <username> -h <host> -p <port> -F c -b <dbname> > backup.dump
```

é¢å¤–çš„é€‰é¡¹åŒ…æ‹¬ `--data-only` å’Œ `--schema-only`ï¼Œè¿™äº›é€‰é¡¹å¯ä»¥è®©ç”¨æˆ·é€‰æ‹©å¤‡ä»½æ•°æ®æˆ–è€…ä»…å¤‡ä»½æ¶æ„ã€‚

ä½¿ç”¨ `pg_restore` æ¥éªŒè¯å¤‡ä»½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚å³ä½¿ä½ ä¸æ‰“ç®—ç«‹å³æ¢å¤ï¼Œä¹Ÿåº”è¯¥å®šæœŸéªŒè¯å¤‡ä»½ã€‚

```shell
pg_restore --list backup.dump
```

#### `pg_restore` æ¢å¤

`pg_restore` æ˜¯ç”¨äºæ¢å¤ç”± `pg_dump` åˆ›å»ºçš„å¤‡ä»½çš„å·¥å…·ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œæ¢å¤ï¼š

```shell
pg_restore -U <username> -h <host> -p <port> -d <dbname> backup.dump
```

**æ³¨æ„**ï¼š

- åœ¨æ¢å¤ä¹‹å‰ï¼Œç¡®ä¿ç›®æ ‡æ•°æ®åº“æ˜¯ç©ºçš„æˆ–ä½ å·²ç»å¤‡ä»½äº†ä»»ä½•é‡è¦çš„æ•°æ®ã€‚
- å¦‚æœå¤‡ä»½æ˜¯åœ¨ä¸åŒç‰ˆæœ¬çš„ PostgreSQL ä¸Šåˆ›å»ºçš„ï¼Œå¯èƒ½ä¼šé‡åˆ°å…¼å®¹æ€§é—®é¢˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¡®ä¿å…ˆæµ‹è¯•æ¢å¤è¿‡ç¨‹ã€‚
- å¦‚æœä½ æ­£åœ¨æ¢å¤åˆ°ä¸€ä¸ªæ´»åŠ¨çš„æ•°æ®åº“ï¼Œä½ å¯èƒ½éœ€è¦åœ¨æ¢å¤å‰åœæ­¢æ•°æ®åº“æœåŠ¡ã€‚

## æ›´æ–°

### å°ç‰ˆæœ¬å‡çº§ï¼ˆMinor Version Upgradeï¼‰

**å°ç‰ˆæœ¬å‡çº§é€šå¸¸æ¶‰åŠåˆ°å®‰å…¨ä¿®å¤å’Œé”™è¯¯ä¿®å¤ï¼Œè€Œä¸ä¼šæ”¹å˜æ•°æ®åº“çš„å†…éƒ¨æ ¼å¼ã€‚**è¿™äº›å‡çº§é€šå¸¸æ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶æ¥å®Œæˆã€‚å¦‚ä¸‹æ˜¯ PostgreSQL 15.3 å‡çº§åˆ° 15.4 çš„å°ç‰ˆæœ¬å‡çº§ç¤ºä¾‹ï¼š

**æ­¥éª¤**:

1. **å¤‡ä»½æ•°æ®**:

   åœ¨è¿›è¡Œä»»ä½•å‡çº§ä¹‹å‰ï¼Œå§‹ç»ˆç¡®ä¿å¤‡ä»½æ‚¨çš„æ•°æ®åº“ã€‚

   ```shell
   pg_dumpall > backup.sql
   ```

2. **åœæ­¢ PostgreSQL æœåŠ¡**:

   ä½¿ç”¨ `pg_ctl stop` æˆ–æ‚¨çš„ç³»ç»Ÿçš„æœåŠ¡ç®¡ç†å·¥å…·åœæ­¢ PostgreSQL æœåŠ¡ã€‚

   ```shell
   pg_ctl stop
   ```

3. **æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶**:

   ä¸‹è½½å¹¶å®‰è£… PostgreSQL 15.4 çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

4. **é‡å¯ PostgreSQL æœåŠ¡**:

   ä½¿ç”¨ `pg_ctl start` æˆ–æ‚¨çš„ç³»ç»Ÿçš„æœåŠ¡ç®¡ç†å·¥å…·é‡æ–°å¯åŠ¨ PostgreSQL æœåŠ¡ã€‚

   ```shell
   pg_ctl start
   ```

5. **æ£€æŸ¥æ—¥å¿—å’Œè¿è¡Œæµ‹è¯•**:

   æ£€æŸ¥ `/usr/local/pgsql/data/pg_log/` ä¸­çš„æ—¥å¿—æ–‡ä»¶ä»¥ç¡®ä¿æ²¡æœ‰é”™è¯¯ï¼Œå¹¶è¿è¡Œä»»ä½•å¿…è¦çš„æµ‹è¯•ä»¥éªŒè¯ç³»ç»Ÿçš„åŠŸèƒ½ã€‚

### è·¨ç‰ˆæœ¬å‡çº§ï¼ˆMajor Version Upgradeï¼‰

è·¨ç‰ˆæœ¬å‡çº§æ¶‰åŠåˆ°ä»ä¸€ä¸ªä¸»ç‰ˆæœ¬å‡çº§åˆ°å¦ä¸€ä¸ªä¸»ç‰ˆæœ¬ï¼Œä¾‹å¦‚ä» PostgreSQL 15 å‡çº§åˆ° PostgreSQL 16ã€‚**è¿™äº›å‡çº§é€šå¸¸ä¼šæ¶‰åŠåˆ°å†…éƒ¨æ ¼å¼çš„å˜åŒ–ï¼Œå› æ­¤éœ€è¦æ›´å¤šçš„æ³¨æ„å’Œå‡†å¤‡ã€‚**å¦‚ä¸‹æ˜¯ PostgreSQL 15.4 å‡çº§åˆ° 16.0 çš„å¤§ç‰ˆæœ¬å‡çº§ç¤ºä¾‹ï¼š

**æ­¥éª¤**:

1. **å¤‡ä»½æ•°æ®**:

   åœ¨è¿›è¡Œä»»ä½•å‡çº§ä¹‹å‰ï¼Œå§‹ç»ˆç¡®ä¿å¤‡ä»½æ‚¨çš„æ•°æ®åº“ã€‚

   ```shell
   pg_dumpall > backup.sql
   ```

2. **æ£€æŸ¥å…¼å®¹æ€§**:

   æ£€æŸ¥æ–°ç‰ˆæœ¬çš„ PostgreSQL æ–‡æ¡£ä»¥ç¡®ä¿æ‚¨çš„åº”ç”¨ç¨‹åºå’Œæ•°æ®åº“æ¶æ„ä¸æ–°ç‰ˆæœ¬å…¼å®¹ã€‚

3. **å®‰è£…æ–°ç‰ˆæœ¬çš„ PostgreSQL**:

   åœ¨åŒä¸€ç³»ç»Ÿä¸Šå®‰è£…æ–°ç‰ˆæœ¬çš„ PostgreSQLï¼Œä½†ä¸è¦è¦†ç›–æ—§ç‰ˆæœ¬ã€‚

4. **ä½¿ç”¨ pg_upgrade æˆ–é€»è¾‘å¤‡ä»½å’Œæ¢å¤**:

   ä½¿ç”¨ `pg_upgrade` å·¥å…·å¿«é€Ÿå‡çº§ã€‚

   ```shell
   pg_upgrade \
   --old-datadir "/usr/local/pgsql/15.4/data" \
   --new-datadir "/usr/local/pgsql/16.0/data" \
   --old-bindir "/usr/local/pgsql/15.4/bin" \
   --new-bindir "/usr/local/pgsql/16.0/bin"
   ```

5. **æµ‹è¯•æ–°é›†ç¾¤**:

   åœ¨æ–°é›†ç¾¤ä¸Šè¿è¡Œæµ‹è¯•ä»¥ç¡®ä¿å®ƒæŒ‰é¢„æœŸå·¥ä½œã€‚

6. **åˆ‡æ¢åˆ°æ–°é›†ç¾¤**:

   ä¸€æ—¦æ»¡æ„ï¼Œå¯ä»¥åˆ‡æ¢åˆ°æ–°é›†ç¾¤å¹¶æ›´æ–°ä»»ä½•è¿æ¥å­—ç¬¦ä¸²å’Œé…ç½®ã€‚

7. **ç›‘æ§æ€§èƒ½å’Œé”™è¯¯**:

   åœ¨å‡çº§åç›‘æ§ç³»ç»Ÿæ€§èƒ½å’Œé”™è¯¯ï¼Œä»¥ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ã€‚

8. **ï¼ˆå¯é€‰ï¼‰åˆ é™¤æ—§é›†ç¾¤**:

   ç¡®ä¿æ–°é›†ç¾¤è¿è¡Œæ­£å¸¸åï¼Œå¯ä»¥é€‰æ‹©åˆ é™¤æ—§é›†ç¾¤ä»¥é‡Šæ”¾ç©ºé—´ã€‚
